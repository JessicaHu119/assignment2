---
title: "assignment_2"
author: "u7457284"
date: "2022-10-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1. Correct analysis of Clark et al. (2020) data (i.e., OA_activitydat_20190302_BIOL3207.csv) to generate the summary statistics (means, SD, N) for each of the fish species’ average activity for each treatment.

### By adding the link in the `()` brackets it will hyperlink "My GitHub Repository". This is how to hyperlink in Rmarkdown documents.

[My GitHub Repository](https://github.com/JessicaHu119/Shiqi-Hu_assigenment2.git)

### Read all files

```{r}
library(tidyverse)
OA <- read_csv("./Data/OA_activitydat_20190302_BIOL3207.csv")
clark_paper <- read_csv("./Data/clark_paper_data.csv")
ocean_meta <- read_csv("./Data/ocean_meta_data.csv")
```

### Calculate means, SD, N for each of the fish species’ average activity for each treatment 

```{r}
data_OA <- OA %>% group_by(species, treatment) %>%
              summarise(mean = mean(activity, na.rm = TRUE),
                        sd = sd(activity, na.rm = TRUE),
                        n = length(unique(animal_id))) %>%
              rename(Species = "species")
```

# 2. Through coding, merge the summary statistics generated from 1) with the metadata (i.e., clark_paper_data.csv) from Clark et al. (2020).

```{r}
cb <- cbind(clark_paper, data_OA)
new <- pivot_wider(cb, names_from = treatment,
                     names_glue = "{treatment}_{.value}",
                     values_from = c("mean", "sd", "n"))
```

# 3. Through coding, correctly merge the combined summary statistics and metadata from Clark et al. (2020) (output from 1 & 2) into the larger meta-analysis dataset (i.e., ocean_meta_data.csv).

```{r}
dim(ocean_meta)
dim(new)
```

### Do some renaming of colnames so they match ocean_meta

```{r}
new1 <-  new %>% rename("oa.mean" = CO2_mean,
                            "oa.sd" = CO2_sd,
                            "oa.n" = CO2_n,
                            "ctrl.mean" = control_mean,
                            "ctrl.sd" = control_sd,
                            "ctrl.n" = control_n)
```

### Reorder col names based on names in ocean_meta

```{r}
new1 <- new1[names(ocean_meta)]
```

### Check columns are in same order

```{r}
colnames(ocean_meta) == colnames(new1)
```

### Bind the two dataframes

```{r}
total <- rbind(ocean_meta, new1)
total <- total %>%  mutate(residual = 1:n())
total <- total[complete.cases(total),]
```

# 4. Correctly calculate the log response ratio (lnRR) effect size for every row of the dataframe using metafor’s escalc() function.

### Load the necessary R Packages
```{r}
library(pacman)
library(orchaRd)
```

### For'measure="ROM" , the log is taken of the ratio of means, which makes this outcome measure symmetric around 0 and yields a coresponding sampling distribution that is closer to normality. Hence, this measure cannot be computed when 'm1i' and 'm2i' have opposite signs.

```{r}
lnRR <- metafor::escalc(measure = "ROM", m1i = ctrl.mean, m2i = oa.mean, sd1i = ctrl.sd, sd2i = oa.sd, n1i = ctrl.n, n2i = oa.n, data = total,
    var.names = c("lnRR", "V_lnRR")) 
```

# 5. Correct meta-analytic model fitted to the data that controls for the sampling variance of lnRR. The model should include a random effect of study and observation. Use metafor’s rma.mv() function.



```{r}
MLMA <- metafor::rma.mv( lnRR~1, V = V_lnRR, random=list(~1|Study, ~1|residual), method = "REML", test = "t", dfs = "contain", data=lnRR)
MLMA
```

# 6. Written paragraph of the findings and what they mean which is supported with a figure. The paragraph should include: 

### Overall meta-analytic mean
We want to know what the overall meta-analytic mean effect size across the studies actually is estimated to be. We can see that from the model by extracting the intercept (labeled ‘estimate’ in the model output). Recall that the model is just an object that stores all the values for us.

We can extract the estimate using the coef function, it is estimated to be 0.098, which tells us that the mean Zr value is positive, but there is a rather weak overall association between physiology and dispersal / movement when we pool across all studies.

If we want to convert the overall meta-analytic mean back to the correlation coefficient we can use the predict function to help with that. We can use the transf argument within the function:

```{r}
predict(MLMA, transf = "transf.ztor")
```

There are LOTS of different transformations that can be done depending on which effect size you plan on using. Get familiar with the predict function and the transf argument by looking at it’s help file.

## Correct presentation and interpretation of overall meta-analytic mean and measures of uncertainty around the mean estimate (e.g., 95% confidence intervals).

The 95% confidence intervals for the overall meta-analysis mean are from -0.350 to  0.098. At the same time, 95% of the time, we would expect the true mean to fall between -0.311 and 0.189 lnRR values.

We can also see that the null hypothesis that lnRR = 0 can not be rejected because there is a significantly smaller estimate than a correlation of 0, which we can see from the p-value being > 0.05. Actually, p-value is 0.2673.

## Measures of heterogeneity in effect size estimates across studies (i.e., I2 and/or prediction intervals - see predict() function in metafor)

```{r}
## Calculate I2
i2_vals <- orchaRd::i2_ml(MLMA)
## Make a pretty table. First, lets clean up the names of the different I2
## estimates. Lets remove I2_. It's a string, so, we can use some regular
## expressions to fix that. `gsub` is pretty useful. You put a pattern in and
## tell it what you would like to replace the text with. In this case, just
## blank will do! Then, we'll make the first letter of what is left
## capitalised.
i2 <- tibble(type = firstup(gsub("I2_", "", names(i2_vals))), I2 = i2_vals)
i2
# You remember flextable. Now, lets make a pretty table. We can so some nice
# modifications here too.
library(flextable)
ft <- flextable(i2)%>%
    align(part = "header", align = "center") %>%
    compose(part = "header", j = 1, value = as_paragraph(as_b("Type"))) %>%
    compose(part = "header", j = 2, value = as_paragraph(as_b("I"), as_b(as_sup("2")),
        as_b("(%)"))) 
ft
```


## Forest plot showing the mean estimate, 95% confidence interval, and prediction interval with clearly labelled axes, number of samples and studies plotted on figure


# 7. Funnel plot for visually assessing the possibility of publication bias.

























